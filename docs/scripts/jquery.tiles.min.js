(function(e){var t=function(t,n,r){this.config=r,this.zoom=t,this.$viewport=n,this.$layer=e("<div/>"),this.width=r.original.width/t,this.height=r.original.height/t};t.prototype.move=function(e,t){var n=this.$viewport.width(),r=this.$viewport.height(),i=t/this.zoom-r/2,s=e/this.zoom-n/2,o=-(n-this.width),u=-(r-this.height);i=Math.max(0,Math.min(u,i)),s=Math.max(0,Math.min(o,s)),n>this.width&&(s=-(n-this.width)/2),r>this.height&&(i=-(r-this.height)/2),this.$layer.css("top",-i),this.$layer.css("left",-s),this.centerX=(s+n/2)*this.zoom,this.centerY=(i+r/2)*this.zoom,n>this.width&&(this.centerX=this.config.original.width/2),r>this.height&&(this.centerY=this.config.original.height/2),this._ondrag()},t.prototype.show=function(){this.$layer.css("z-index",2),this.$layer.css("display","block")},t.prototype.hide=function(){this.$layer.css("z-index",1),this.$layer.css("display","none")},t.prototype.resetContainment=function(){var e=this.$viewport,t=this.$layer,n=e.offset(),r=this.width,i=this.height,s=[n.left+e.width()-r,n.top+e.height()-i,n.left,n.top];e.width()>r&&(s[0]=n.left+(e.width()-r)/2,s[2]=n.left+(e.width()-r)/2),e.height()>i&&(s[1]=n.top+(e.height()-i)/2,s[3]=n.top+(e.height()-i)/2),t.draggable("option","containment",s)},t.prototype.load=function(){var t=this.$viewport,n=this.$layer,r=this.zoom,i=this.config,s=this.width,o=this.height,u=i.tileSize;n.css("position","absolute");var a=Math.ceil(s/u),f=Math.ceil(o/u);for(var l=1;l<=f;l++){var c=e("<div/>");for(var h=1;h<=a;h++){var p=e("<div/>");p.css({width:u,height:u,"float":"left","text-align":"left","vertical-align":"top"}),i.loading&&p.css("background","url("+i.loading+") center center no-repeat");var d=e("<img/>");l!==f?d.attr("height",u):d.attr("height",o%u),h!==a?d.attr("width",u):d.attr("width",s%u);var v=["tiles",r,h,l].join("-");d.addClass(v),d.data("loaded",!1),d.data("src",i.basePath+"tiles/"+r+"/"+h+"_"+l+".jpg"),d.hide(),p.append(d),c.append(p)}c.css("width",a*u),n.append(c)}t.append(n);var m=this;n.draggable({drag:function(){m._ondrag()}}),this.resetContainment(),this._ondrag(),this.hide()},t.prototype._ondrag=function(){var t=this.config.tileSize,n=this.$layer.position(),r=Math.floor(-n.left/t)+1,i=Math.ceil((-n.left+this.$viewport.width())/t),s=Math.floor(-n.top/t)+1,o=Math.ceil((-n.top+this.$viewport.height())/t);for(var u=r;u<=i;u++)for(var a=s;a<=o;a++){var f=[".tiles",this.zoom,u,a].join("-"),l=this.$layer.find(f);l.data("loaded")||(l.attr("src",l.data("src")),l.data("loaded",!0),l.load(function(){e(this).fadeIn(250)}))}this.centerX=(-n.left+this.$viewport.width()/2)*this.zoom,this.centerY=(-n.top+this.$viewport.height()/2)*this.zoom};var n=function(t,n,r){this.config=r,this.zoom=t,this.$viewport=n;var i=e("<div/>");n.children().each(function(t){e(this).detach().appendTo(i)}),this.$layer=i,this.centerX=0,this.centerY=0};n.prototype.show=function(){this.$layer.css("z-index",2),this.$layer.css("display","block")},n.prototype.hide=function(){this.$layer.css("z-index",1),this.$layer.css("display","none")},n.prototype.load=function(){this.$viewport.append(this.$layer)},n.prototype.move=function(e,t){this.centerX=e,this.centerY=t};var r={init:function(r){var i=e.extend({original:{width:null,height:null},tileSize:500,basePath:"",loading:"",zoom:0,no0zoom:!1},r);if(typeof i.original.width!="number"||typeof i.original.height!="number")throw"Missing required fields original.width and original.height.";if(i.original.width<=0||i.original.height<=0)throw"Both original.width and original.height must be > 0";var s=e.trim(i.basePath);return s&&s.indexOf("/",s.length-1)===-1&&(s+="/"),i.basePath=s,this.data("config",i),this.each(function(){var r=e(this);r.css("position","relative"),r.css("overflow","hidden");var s={};if(!i.no0zoom)s[0]=new n(0,r,i),s[0].load(),s[0].hide();else if(i.zoom===0)throw"You must specify a non-zero zoom if no0zoom is true";var o=i.zoom;o!==0&&(s[o]=new t(o,r,i),s[o].load()),s[o].show(),r.data("layers",s),r.data("zoom",o);var u=function(){e.each(s,function(e,t){if(e===0)return;t.resetContainment(),t._ondrag()})},a=null;r.bind("resize reposition",function(){a&&clearTimeout(a),a=setTimeout(u,300)})})},zoom:function(n){var r=this.data("config");return this.each(function(){var i=e(this),s=i.data("zoom");if(s===n)return;var o=i.data("layers"),u=o[s].centerX,a=o[s].centerY;o[s].hide(),s=n,o[s]||(o[s]=new t(s,i,r),o[s].load()),o[s].show(),o[s].move(u,a),i.data("layers",o),i.data("zoom",s)})},move:function(t,n){var r=this.data("config");return this.each(function(){var r=e(this),i=r.data("zoom"),s=r.data("layers");s[i].move(t*i,n*i)})},center:function(){var t=this.data("config");return this.each(function(){var n=e(this),r=n.data("zoom"),i=n.data("layers");i[r].move(t.original.width/2,t.original.height/2)})}};e.fn.tiles=function(t){if(r[t])return r[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return r.init.apply(this,arguments);e.error("No such method: "+t)}})(jQuery);